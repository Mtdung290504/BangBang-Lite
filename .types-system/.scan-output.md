# Code Scan Results

Thời gian quét: 22:37:37 14/9/2025
Tổng số file: 23
Tool scanner: index.js (đã bỏ qua)

---

dsl/enums/damage-types.ts:

```typescript
type TankDamageType = 'physical' | 'energy';
type DamageType = 'true' | TankDamageType;

export type { TankDamageType, DamageType };
```

dsl/events/event-manifest.ts:

```typescript
import { SkillCastAction } from '../skills/actions/skill-actions';

type TankEventActors = {
	[K in [
		// Khi dùng skill thì kích hoạt thêm gì đó
		'on-activate-skill',

		// Trigger các event ví dụ fatal damage, HP < 30%,...
		'on-hit-taken',

		// Chưa lường trước được nhưng có thể sẽ dùng
		'on-hit-dealt',

		// Hit only (Trúng skill/đánh thường kích hoạt gì đó hoặc skill/đánh thường trúng đích kích hoạt gì đó)
		'on-skill-taken',
		'on-skill-dealt',
		'on-normal-attack-taken',
		'on-normal-attack-dealt',

		// Hit and dealt damage (Như trên nhưng phải có chịu damage mới kích hoạt)
		'on-skill-taken-damage',
		'on-skill-dealt-damage',
		'on-normal-attack-taken-damage',
		'on-normal-attack-dealt-damage',

		// Khi tử vong hoặc khi kill
		'on-destroy',
		'on-destroyed'
	][number]]: ('self' | 'source' | 'target')[];
};

interface TankEventActorsMap extends TankEventActors {
	'on-activate-skill': ['self'];
	'on-hit-taken': ['source', 'self'];
	'on-hit-dealt': ['target', 'self'];
	'on-skill-taken': ['source', 'self'];
	'on-skill-dealt': ['target', 'self'];
	'on-normal-attack-taken': ['source', 'self'];
	'on-normal-attack-dealt': ['target', 'self'];
	'on-skill-taken-damage': ['source', 'self'];
	'on-skill-dealt-damage': ['target', 'self'];
	'on-normal-attack-taken-damage': ['source', 'self'];
	'on-normal-attack-dealt-damage': ['target', 'self'];
	'on-destroy': ['target', 'self'];
	'on-destroyed': ['source', 'self'];
}

interface SkillEventHandler {
	/** Khi skill trúng 1 target nào đó, khai báo những gì áp dụng lên target */
	'on-hit': { [K in ['ally', 'enemy', 'self'][number]]?: SkillCastAction[] };

	/** Khi gây sát thương thành công, bản thân kích hoạt gì đó, áp dụng lên kẻ địch gì đó */
	'on-dealt-damage'?: { [K in ['enemy', 'self'][number]]?: SkillCastAction[] };
}

// Usage in future:
// type T = { [K in SkillEventActorsMap['on-hit'][number]]: any };

export type { TankEventActorsMap, SkillEventHandler };
```

dsl/map-manifest.ts:

```typescript
interface MapManifest {
	'other-save'?: any;
	size: { width: number; height: number };

	/**
	 * Mảng 3 chiều, chiểu đầu tiên là 2 team
	 * Chiều tiếp theo chứa 5 vị trí xuất hiện
	 * Chiều cuối cùng chứa tọa độ [x, y]
	 */
	'appear-coords': number[][][];
}

export type { MapManifest };
```

dsl/skill-manifest.ts:

```typescript
import type { SkillEntry } from './skills/manifest/manifest.active-skill';
import type { PassiveSkillEntry } from './skills/manifest/manifest.passive-skill';

/**
 * Định nghĩa tổng cho manifest, có thể có phase hoặc skill
 * @todo Cần bổ sung thêm `passive` skill
 */
interface SkillManifest<Phases extends number[] = []> {
	/** Nếu có phase, khai báo các phase */
	phases?: Phases extends [] ? never : Phases;

	// Passive skills
	passive: PassiveSkillEntry<Phases>[];

	// Active skills
	'normal-attack': SkillEntry<Phases>;
	s1: SkillEntry<Phases>;
	s2: SkillEntry<Phases>;
	ultimate: SkillEntry<Phases>;
}

export type { SkillManifest };

const test: SkillManifest = {
	passive: [
		{
			type: 'permanent-buff',
			'stat-modifiers': [
				{
					attribute: 'flight-speed',
					value: { amount: 50 },
				},
			],
		},
		{
			type: 'event-triggered',
			'trigger-event': 'on-activate-skill',
			actions: ['implement-later: Tạo khiên phản đòn'],
		},
	],

	'normal-attack': {
		type: 'normal',
		property: 'normal-attack',
		actions: [
			{
				name: 'create-default-projectile',
				collider: { type: 'rectangle', size: { width: 0, height: 0 } },
				enhancements: [{ name: 'bouncing', 'hit-limit': 3, 'damage-reduction': { amount: 50 } }],
				'on-dealt-damage': { self: ['implement-later: Hồi 5 năng lượng'] },
			},
		],
	},

	s1: {
		type: 'normal',
		property: 'skill',
		cooldown: 8,

		'casting-method': {
			type: 'on-target',
			target: 'enemy',
		},

		'resource-consumption': { energy: { amount: 25, unit: 'unit' } },
		actions: ['implement-later: Gây damage, tăng tốc, bóng quay về'],
	},

	s2: {
		type: 'stacked',
		property: 'skill',
		'max-stack': 2,
		'stack-time': 8,
		cooldown: 1.5,
		'resource-consumption': { energy: { amount: 50, unit: 'unit' } },
		actions: ['implement-later: Lướt'],
	},

	ultimate: {
		type: 'normal',
		property: 'skill',
		cooldown: 8,
		'resource-consumption': { energy: { amount: 0, unit: 'unit' } },
		actions: ['implement-later: Tung bóng bay xuyên, đẩy lui'],
	},
};
```

dsl/skills/actions/apply_effect/apply-movement-speed.ts:

```typescript

```

dsl/skills/actions/apply_effect/dealt-damage.ts:

```typescript
import type { SurvivalStats, AttackPowerStats, AdditionalStats } from '../../../tank-manifest';
import type { ValueWithUnit } from '../../value-with-unit';
import type { DamageType } from '../../../enums/damage-types';

interface DealtDamage {
	name: 'dealt-damage';

	source: {
		attribute:
			| keyof SurvivalStats
			| keyof AttackPowerStats
			| keyof AdditionalStats
			| 'current-HP'
			| 'lost-HP'
			| 'current-energy-point';
		of: 'self' | 'target';
	};

	value: ValueWithUnit;

	/** Mặc định là `main` */
	type?: 'main' | 'bonus';

	/** Mặc định kế thừa từ tank */
	'damage-type'?: DamageType;
}

export type { DealtDamage };
```

dsl/skills/actions/create_attack/create-projectile.ts:

```typescript
import type { Collider } from '../../../../src/core/physics/dsl.ColliderDeclaration';
import type { SpriteDeclaration } from '../../../../src/graphic/dsl.SpriteDeclaration';

import type { SkillEventHandler } from '../../../events/event-manifest';
import type { ValueWithUnit } from '../../value-with-unit';

/** Projectile enhancement: can track a target */
interface Tracking {
	name: 'tracking';
}

/** Projectile enhancement: can pierce targets */
interface Piercing {
	name: 'piercing';

	/** Unlimited by default */
	'hit-limit'?: number;

	/** Default: 0 */
	'damage-reduction'?: ValueWithUnit;
}

/** Projectile enhancement: can bounce between targets */
interface Bouncing {
	name: 'bouncing';
	'hit-limit': number;

	/** Default: 0 */
	'damage-reduction'?: ValueWithUnit;
}

/** Projectile enhancements union type */
type ProjectileEnhancement = Tracking | Piercing | Bouncing;

interface CreateProjectileOptions extends SpriteDeclaration, SkillEventHandler {
	name: string;

	/** Inherit from tank by default */
	'flight-range'?: number;

	/** Inherit from tank by default */
	'flight-speed'?: number;

	/** Sprite xuất hiện khi đánh trúng */
	'hit-effect-sprite'?: string;

	collider: Collider;
}

/**
 * Default shooting action with sprite key = `normal-attack`
 *
 * Note:
 * - flight-range: inherit
 * - flight-speed: inherit
 * - sprite-key: normal-attack
 * - on-hit: dealt normal-attack damage
 *
 */
interface CreateDefaultProjectile
	extends Omit<CreateProjectileOptions, 'flight-range' | 'flight-speed' | 'sprite-key' | 'on-hit'> {
	name: 'create-default-projectile';
	enhancements?: ProjectileEnhancement[];

	/** Tùy chọn vì mặc định đã là gây damage */
	'on-hit'?: SkillEventHandler['on-hit'];

	// Note:
	// flight-range: inherit
	// flight-speed: inherit
	// sprite-key: normal-attack
	// on-hit: dealt normal-attack damage
}

interface CreateCustomProjectile extends CreateProjectileOptions {
	name: 'create-custom-projectile';
	enhancements?: ProjectileEnhancement[];
}

export type CreateProjectileAction = CreateDefaultProjectile | CreateCustomProjectile;

// Usages

const defaultShoot: CreateDefaultProjectile = {
	name: 'create-default-projectile',
	collider: {
		type: 'rectangle',
		size: { width: 0, height: 0 },
	},
};
const customShoot: CreateCustomProjectile = {
	name: 'create-custom-projectile',
	'sprite-key': 's1',
	'flight-range': 600,
	'flight-speed': 15,
	'on-hit': {
		enemy: ['implement-later:'],
	},
	'on-dealt-damage': {
		self: ['implement-later:'],
	},
	enhancements: [
		{
			name: 'bouncing',
			'hit-limit': 3,
			'damage-reduction': { amount: 25 },
		},
	],

	collider: {
		type: 'rectangle',
		size: { width: 0, height: 0 },
	},
};
```

dsl/skills/actions/move/dash.ts:

```typescript
interface Dash {
	range: number;
	speed: number;

	/**Mặc định: false */
	'through-wall'?: boolean;

	/**Mặc định: false */
	'through-tank'?: boolean;
}

export type { Dash };
```

dsl/skills/actions/skill-actions.ts:

```typescript
import type { DealtDamage } from './apply_effect/dealt-damage';
import type { CreateProjectileAction } from './create_attack/create-projectile';
import type { SkillCast, SkillCastingMethods, TargetedSkillCast } from '../context/context.casting-methods';

type SkillCastAction<CastingMethod extends SkillCastingMethods = SkillCastingMethods> = CastingMethod extends SkillCast
	? CreateProjectileAction | `implement-later:${string}`
	: CastingMethod extends TargetedSkillCast
	? DealtDamage | `implement-later:${string}`
	: `implement-later:${string}`;

type PassiveSkillAction = `implement-later:${string}`;

export type { SkillCastAction, PassiveSkillAction };
```

dsl/skills/base-skill.ts:

```typescript
import type { SkillConsumption } from './skill-consumption';
import type { SkillCastAction } from './actions/skill-actions';
import type { SkillCast, SkillCastingMethods, TargetedSkillCast } from './context/context.casting-methods';

/** Thời gian hồi chiêu dùng chung cho mọi skill */
interface SkillTiming {
	/** Thời gian hồi chiêu, đơn vị: giây (Mặc định: 0) */
	cooldown?: number;
}

/**
 * Helper type để tạo skill với casting method cụ thể
 */
type WithCasting<T, CastMethod extends SkillCastingMethods> = T & {
	'casting-method'?: CastMethod;
	'resource-consumption'?: SkillConsumption;
	property: 'skill' | 'normal-attack';
	actions: SkillCastAction<CastMethod>[];
};

/**
 * Helper để tạo ActionBased với tất cả casting methods
 */
type ActionBased<T = {}> = WithCasting<T, SkillCast> | WithCasting<T, TargetedSkillCast>;

export type { SkillTiming, WithCasting, ActionBased };
```

dsl/skills/context/context.casting-methods.ts:

```typescript
/**
 * @description
 * - Mô tả skill được tung ra bằng cách nào để làm indicator
 * - Không chỉ thế, còn giới hạn bớt context mà các action có thể sử dụng
 */

interface UseRange {
	/** Quy định phạm vi kích hoạt chiêu, mặc định bằng tầm bắn của tank */
	range?: number;
}

/**
 * Skill người chơi khóa mục tiêu (Ví dụ: Q mất máu)
 */
interface ChosenTargetCast extends UseRange {
	type: 'on-target';
	target: 'any' | 'ally' | 'enemy';
}

/**
 * Skill khóa mục tiêu nhưng mục tiêu gần nhất thay vì player chọn
 */
interface NearestTargetCast extends Omit<ChosenTargetCast, 'type'> {
	type: 'on-nearest-target';
}

type TargetedSkillCast = ChosenTargetCast | NearestTargetCast;

/** Chỉ bấm nút là dùng (Ví dụ: R Tào Tháo) */
interface ImmediateCast {
	type: 'immediately';
}

/** Skill chọn vùng tung ra (Ví dụ: R Magneto) */
interface AreaCast extends UseRange {
	type: 'at-area';

	/** Không tác động đến logic game, chỉ hiển thị vòng tròn có d = size chỉ định */
	display?: { size: number };
}

/** Skill theo hướng (Ví dụ: E TV)*/
interface DirectionCast extends UseRange {
	type: 'in-direction';

	/** Không tác động đến logic game, chỉ hiển thị mũi tên có width = size chỉ định */
	display?: { size: number };
}

type SkillCast = ImmediateCast | AreaCast | DirectionCast;

type SkillCastingMethods = TargetedSkillCast | SkillCast;

export type { SkillCast, TargetedSkillCast, SkillCastingMethods };
```

dsl/skills/context/context.skill-action-context.ts:

```typescript
export type SkillActionContext = 'mouse-pos' | 'mouse-direction' | 'reverse-mouse-direction' | 'self-pos';
export type TargetedSkillActionContext = 'target-pos';
```

dsl/skills/manifest/manifest.active-skill.ts:

```typescript
import type { ActionBased, SkillTiming } from '../base-skill';

/**
 * Skill cơ bản, dùng xong hồi chiêu, không có gì đặc biệt
 */
type NormalSkill = SkillTiming &
	ActionBased & {
		type: 'normal';
	};

/**
 * Skill có tích lũy
 */
type StackedSkill = SkillTiming &
	ActionBased & {
		type: 'stacked';

		/** Số stack tối đa */
		'max-stack': 2 | 3 | 5;

		/** Thời gian hồi 1 stack, đơn vị: giây */
		'stack-time': number;
	};

/**
 * Skill nhiều giai đoạn
 */
type MultiStageSkill = SkillTiming & {
	type: 'multi-stage';

	/** Danh sách hành vi của các giai đoạn */
	stages: ActionBased[];

	/** Quy định giới hạn thời gian tồn tại của 1 giai đoạn, đơn vị: giây */
	timeout: number;
};

/**
 * Skill thay đổi hành vi theo phase (Trạng thái/Hệ)
 */
type PhasedSkill<Phases extends number[]> = {
	type: 'phased';

	/** Phase ban đầu được dùng */
	'default-phase': Phases[number];

	/** Định nghĩa từng phase như 1 skill đơn */
	'phases-definition': Record<Phases[number], NormalSkill>;
};

// Các union dùng cho manifest
type SingleSkill = NormalSkill | StackedSkill | MultiStageSkill;

/** Chuyển kiểu theo có phase hay skill */
type SkillEntry<Phases extends number[]> = Phases extends [] ? SingleSkill : SingleSkill | PhasedSkill<Phases>;

export type { SkillEntry };
```

dsl/skills/manifest/manifest.passive-skill.ts:

```typescript
import type { TankEventActorsMap } from '../../events/event-manifest';
import { AttackPowerStats, ShootingStats, SurvivalStats } from '../../tank-manifest';
import { ValueWithUnit } from '../value-with-unit';

import type { SkillTiming } from '../base-skill';

// Note sửa ActionBased thành chuyên biệt cho passive skill
import type { PassiveSkillAction } from '../actions/skill-actions';

/**
 * Bị động kích hoạt theo event - Ví dụ Kirito
 */
interface EventTriggeredPassive extends SkillTiming {
	type: 'event-triggered';

	/** Event nào sẽ trigger */
	'trigger-event': keyof TankEventActorsMap;

	/**
	 * Điều kiện để trigger (optional)
	 * - Ví dụ trigger khi chịu dame, mà chịu xong HP phải dưới 30% mới kích hoạt
	 */
	condition?: [];

	/** Hành động khi trigger */
	actions: PassiveSkillAction[];
}

/**
 * Bị động kích hoạt định kỳ theo thời gian (countdown) - Ví dụ: Hồ lô, Khiên LLQ/Iron/Chop
 */
interface PeriodicPassive extends SkillTiming {
	type: 'periodic';

	/** Hành động khi trigger */
	actions: PassiveSkillAction[];

	/** Điều kiện để có thể trigger (optional) */
	conditions?: [];

	// Còn rắc rối khi cần kiểu "Khiên vỡ mới CD", có khi tách thành loại riêng cho lành
}

/**
 * Bị động buff chỉ số (có thể có hoặc không có điều kiện) - Ví dụ: Báo đen, Sát thủ
 */
interface PermanentBuffPassive {
	type: 'permanent-buff';

	/** Các stat được buff (Triển khai sau) */
	'stat-modifiers': {
		attribute: keyof ShootingStats | keyof SurvivalStats | keyof AttackPowerStats;
		value: ValueWithUnit;
	}[];

	/**
	 * Điều kiện để buff có hiệu lực (optional)
	 * - Ví dụ HP thấp hơn 40% mới tăng tốc
	 * - Xung quanh không có đồng đội
	 */
	conditions?: [];
}

// Phased passive skill (cho tank có nhiều phase)
interface PhasedPassiveSkill<Phases extends number[]> {
	type: 'phased';

	/** Phase ban đầu được dùng */
	'default-phase': Phases[number];

	/** Định nghĩa passive cho từng phase */
	'phases-definition': Record<Phases[number], SinglePassiveSkill>;
}

// Union type cho tất cả passive skills
type SinglePassiveSkill = EventTriggeredPassive | PeriodicPassive | PermanentBuffPassive;

// Entry type cho passive skill
type PassiveSkillEntry<Phases extends number[]> = Phases extends []
	? SinglePassiveSkill
	: SinglePassiveSkill | PhasedPassiveSkill<Phases>;

export type { PassiveSkillEntry };
```

dsl/skills/skill-consumption.ts:

```typescript
import type { ValueWithUnit } from './value-with-unit';

/** Tiêu hao cả năng lượng và máu */
type SkillConsumptionBuilder<T extends string[] = []> = Partial<{ [K in T[number]]: ValueWithUnit }>;

type CONSUMPTION_TYPES = ['limit-HP', 'current-HP', 'energy'];

/**
 * Khai báo tiêu hao khi dùng skill
 */
type SkillConsumption = SkillConsumptionBuilder<CONSUMPTION_TYPES>;

export type { SkillConsumption };
```

dsl/skills/value-with-unit.ts:

```typescript
/** Unit đo lường chung cho các giá trị */
type ValueUnit = 'unit' | 'percent';

/**
 * - Generic interface cho giá trị có đơn vị đo
 * - Có thể dùng cho: skill consumption, damage, healing, shield,...
 */
interface ValueWithUnit {
	amount: number;

	/**
	 * Default: `percent`
	 * (Dùng unit khi muốn sử dụng đơn vị mặc định của ngữ cảnh, ví dụ điểm với năng lượng, giây với thời gian CD)
	 */
	unit?: ValueUnit;
}

export type { ValueWithUnit };
```

dsl/tank-manifest.ts:

```typescript
import type { ValueWithUnit } from './skills/value-with-unit';
import type { TankDamageType } from './enums/damage-types';

interface ShootingStats {
	'fire-rate': 60 | 90 | 120;
	'fire-range': 336 | 408 | 480 | 552 | 168;
	'flight-speed': 10;
}

interface SurvivalStats {
	'limit-HP': number;
	'physical-armor': number;
	'energy-shield': number;
}

interface AttackPowerStats {
	'damage-type': TankDamageType;
	'attack-power': number;
	penetration: number;
	'crit-damage': 150 | 200;
}

interface AdditionalStats {
	'energy-point': {
		amount: 100 | 150 | 200;
		recover?: {
			every: number;
			amount: ValueWithUnit;
		};
	};
}

interface FullStats {
	shooting: ShootingStats;
	survival: SurvivalStats;
	'attack-power': AttackPowerStats;
	additional?: AdditionalStats;
	'movement-speed': 160 | 165 | 170 | 175 | 180;
}

interface TankManifest {
	/** Thực tế hiện tại không cần, đưa vào đọc manifest cho dễ */
	name: string;

	/** Default: 52.5 */
	'hitbox-size'?: number;

	/** Default: 52.5 */
	'render-size'?: number;

	'stat-components': FullStats;
}

export type { TankManifest, ShootingStats, SurvivalStats, AttackPowerStats, AdditionalStats };
```

src/core/combat/faction.ts:

```typescript
export type Faction = 'ally' | 'enemy' | 'self' | 'neutral';
```

src/core/physics/dsl.ColliderDeclaration.ts:

```typescript
interface Rectangle {
	type: 'rectangle';
	size: {
		width: number;
		height: number;
	};
}

interface Circle {
	type: 'circle';
	size: { radius: number };
}

export type Collider = Rectangle | Circle;
```

src/graphic/dsl.SpriteDeclaration.ts:

```typescript
export type SpriteDeclaration = {
	/** Sprite key của thực thể để render */
	'sprite-key': string;

	/** Nếu không khai báo, mặc định lấy `frame-size` từ `sprite-manifest` */
	'render-size'?: {
		width: number;
		height: number;
	};
};
```
