# Code Scan Results

Thời gian quét: 13:59:39 18/2/2026
Tổng số file: 39
---


dsl/.enums.ts:
```typescript
export type TestKey = '*for-test:do-not-use-this-key';
export type RandomDefinition = 'random';
```


dsl/.examples/basic.ts:
```typescript
import { CreateContextImpactor, CreateNonContextImpactor } from '../entity/skill/actions/create-attack.type-entities';

const skill_1: CreateNonContextImpactor = {
	action: '@create-entity',
	// Có thể trống
	// strategy: { type: 'direction', 'delta-angle': 0 },

	// Tầm, hướng bay, xuất phát từ đâu
	'limit-range': '100%',
	movement: { 'move-type': 'straight', speed: { value: '17.5u' } },
	from: 'self-pos',

	collider: {
		shape: { type: 'circle', size: { radius: 20 } },
		pierce: ['architecture', 'self', 'ally'],
	},

	visual: { sprite: { key: 'normal-attack' } },

	impact: {
		// interval: 0.5,
		visual: { sprite: { key: 'normal-attack-impact' } },
		actions: [
			{
				// Trúng đồng minh/bản thân giúp tăng 50% tốc chạy trong 2s
				'affected-faction': ['ally', 'self'],
				'target-effect': [
					{
						action: '@apply:effect',
						'effect-manifest': {
							duration: 2,
							impacts: [
								{
									'modify-stats': [{ 'value-from': { attribute: 'movement-speed', value: '50%' } }],
								},
							],
						},
					},
				],
			},
			{
				// Trúng mục tiêu không phải phe mình thì không cần khai báo 'affected-faction'
				'self-action': [
					{
						// Bản thân hồi HP
						action: '@apply:effect',
						'effect-manifest': {
							impacts: [
								{
									'on-start': [
										{
											action: '@apply:recover-hp',
											'value-from': { attribute: 'attack-power', value: '150%', of: 'self' },
										},
									],
								},
							],
						},
					},
				],
				'target-effect': [
					{
						action: '@apply:effect',
						'effect-manifest': {
							impacts: [
								{
									'on-start': [
										{
											action: '@apply:dealt-damage',
											'value-from': { attribute: 'attack-power', value: '175%', of: 'self' },
											'not-main-damage': true,
										},
										{
											action: '@apply:dealt-damage',
											'value-from': { attribute: 'lost-HP', of: 'target', value: '5%' },
											'damage-type': 'true',
											'text-delta-angle': 1,
										},
									],
								},
							],
						},
					},
				],
			},
		],
	},
};

const skill_2: CreateContextImpactor = {
	action: '@create-entity',

	strategy: { type: 'targeting' },
	// strategy: { type: 'targeting', method: 'weakest' },

	from: 'mouse-pos',
	movement: { 'move-type': 'straight', speed: { value: '100%' } },
	impact: {
		actions: [
			{
				'self-action': [{ action: '@do-act:change-phase', method: 'to-phase:3' }],
				'target-effect': [
					{
						action: '@apply:effect',
						'effect-manifest': {
							impacts: [
								{
									'on-start': [
										{
											action: '@apply:dealt-damage',
											'value-from': { attribute: 'attack-power', of: 'self', value: '150%' },
										},
									],
								},
							],
						},
					},
				],
			},
		],
	},
	collider: { shape: { type: 'circle', size: { radius: 100 } } },
};
```


dsl/.examples/e-chop.ts:
```typescript
import { CreateContextImpactor } from '../entity/skill/actions/create-attack.type-entities';

export const def: CreateContextImpactor = {
	action: '@create-entity',
	strategy: {
		type: 'targeting',
		method: 'active-lock',
	},
	from: 'target-pos',
	impact: {
		actions: [
			{
				'affected-faction': ['ally', 'self'],
				'target-effect': [
					{
						action: '@apply:effect',
						'effect-manifest': {
							visual: { sprite: { key: 'e-chop-buff' } },
							description: 'Hồi 201% x Tấn Công HP và tăng tốc 50% trong 2s',
							duration: 2,
							impacts: [
								{
									'on-start': [
										{
											action: '@apply:recover-hp',
											'value-from': { attribute: 'attack-power', of: 'self', value: '201%' },
										},
									],
									'modify-stats': [{ 'value-from': { attribute: 'movement-speed', value: '50%' } }],
									visual: { sprite: { key: 'e-chop-effect' }, duration: 'sprite-end' },
								},
							],
						},
					},
				],
			},
		],
	},
};
```


dsl/.examples/nor-atk-star.ts:
```typescript
import { CreateContextImpactor, CreateNonContextImpactor } from '../entity/skill/actions/create-attack.type-entities';

export default {
	action: '@create-entity',
	'is-fly-object': true,

	// Đã mặc định, không cần khai báo thêm
	// visual: { sprite: { key: 'normal-attack' } },
	// strategy: { type: 'direction', 'delta-angle': 0 },
	// from: 'self-pos',
	// 'limit-range': '100%',
	// movement: { 'move-type': 'straight', speed: { value: '150%', of: 'flight-speed' } },
	movement: { 'move-type': 'straight', speed: { value: '150%' } },

	collider: {
		shape: {
			type: 'rectangle',
			size: { width: 35, height: 15 },
		},
	},

	impact: {
		visual: { sprite: { key: 'physic-hit' }, duration: 'sprite-end' },
		actions: [
			// Đánh trúng đích gây ST, cộng dồn tăng tốc độ, tốc công
			{
				'self-action': [
					{
						action: '@apply:effect',
						'effect-manifest': {
							name: 'star-inc-fire-rate',
							duration: 2,
							description: 'Tăng tốc độ 5%, tốc công 10% trong 2s, tối đa cộng dồn 4 tầng',
							visual: { sprite: { key: 'star-inc-fire-rate-icon' } },
							impacts: [1, 2, 3, 4].map((stack) => ({
								'modify-stats': [
									{ 'value-from': { attribute: 'fire-rate', of: 'self', value: `${10 * stack}%` } },
								],
							})),
						},
					},
				],
				'target-effect': [
					{
						action: '@apply:effect',
						'effect-manifest': {
							description: 'Gây 80% x tấn công ST',
							impacts: [
								{
									'on-start': [
										{
											action: '@apply:dealt-damage',
											'value-from': { attribute: 'attack-power', value: '80%' },
										},
									],
								},
							],
						},
					},
				],
			},

			// Trúng địch gây hiệu ứng thiêu đốt và làm chậm
			{
				'affected-faction': ['enemy'],
				'target-effect': [
					{
						action: '@apply:effect',
						'effect-manifest': {
							name: 'star-dec-mov-spd',
							duration: 2,
							description: 'Giảm tốc 10% và chịu ST đốt, tối đa cộng dồn 4 tầng',
							visual: { sprite: { key: 'star-dec-mov-spd-icon' } },
							impacts: [1, 2, 3, 4].map((stack) => ({
								visual: { sprite: { key: `star-burn-effect-${stack}` } },
								'modify-stats': [
									{
										'value-from': {
											attribute: 'movement-speed',
											of: 'self',
											value: `${-10 * stack}%`,
										},
									},
								],
								'on-interval': [
									{
										action: '@apply:dealt-damage',
										'value-from': {
											attribute: 'attack-power',
											of: 'self',
											value: `${20 * stack}%`,
										},
										'not-main-damage': true,
										'text-delta-angle': 1,
									},
								],
							})),
						},
					},
				],
			},
		],
	},
} satisfies CreateNonContextImpactor;
```


dsl/.types.ts:
```typescript
/** Unit đo lường chung cho các giá trị */
export type ValueUnit = 'u' | '%';

/**
 * - Generic interface cho giá trị có đơn vị đo
 * - Có thể dùng cho: skill consumption, damage, healing, shield,...
 *
 * Ví dụ:
 * - Amount không charge scalable: `100%` hay `25u` (với u viết tắt cho unit)
 * - Amount charge scalable: `100% *0.5` hay `25u *1`
 * 	- Sau dấu * là hệ số nhân với charge time hoặc có thể xem là `mức tăng/s`
 * 	- Ví dụ `100% +*0.5/s` và thời gian charge là `3s` thì Value = 100% * (1 + 0.5 * 3) = 250% (*Cộng thêm 1 để 0s charge không bị 0 value*)
 */
export type ValueWithUnit<
	ChargeScalable extends boolean = false,
	Amount extends number = number,
> = `${Amount}${ValueUnit}${ChargeScalable extends true ? ` ${'+' | '-'}*${number}/s` | '' : ''}`;

export type InheritDeclaration<T extends string> = `inherit:${T}`;

/**
 * Định nghĩa T là Record phải có key thỏa mãn K và value thỏa mãn V
 * @example type Account = PredefinedKeysRecord<'id' | 'password', string, { id: string, password: string }>
 */
export type TypedRecord<K extends PropertyKey, V, T extends Record<K, V>> = T;

/** Chuyển object thành Partial kể cả các object lồng */
export type DeepPartial<T> = T extends any[] ? T : T extends object ? { [K in keyof T]?: DeepPartial<T[K]> } : T;
```


dsl/combat/.enums.ts:
```typescript
/**
 * Đại diện cho phe (faction) của một entity trong game.
 * Dùng để xác định quan hệ giữa caster và target trong các hành động (action) hoặc hiệu ứng (effect).
 *
 * Các giá trị:
 * - `ally`: Đồng minh — cùng phe với người thi triển (caster).
 * - `enemy`: Kẻ địch — khác phe với người thi triển.
 * - `self`: Chính bản thân caster.
 * - `neutral`: Trung lập — không thuộc phe nào, thường dùng cho môi trường hoặc vật thể (ví dụ: bẫy, creep, trụ).
 */
export type Faction = 'ally' | 'enemy' | 'self' | 'neutral';
```


dsl/combat/effect.type-components.ts:
```typescript
import { ValueWithUnit } from '../.types';
import { TankStatValueKey } from '../entity/tank/.enums';

export interface StatValue<T extends TankStatValueKey = TankStatValueKey> {
	'value-from': {
		attribute: T;
		value: ValueWithUnit;

		/** Mặc định: `target` */
		of?: 'self' | 'target';
	};
}
```


dsl/combat/props.type-components.ts:
```typescript
export interface Bounceable {
	bounce?: {
		limit: number;
		'bounce-range': number;
	};
}

export interface Pursuitable {
	/**Đạn có đuổi mục tiêu hay không */
	pursuit?: true;
}
```


dsl/combat/state.type-components.ts:
```typescript
import { ImpactAction } from '../entity/skill/actions/.types';
import { Renderable, VisualManifest } from './visual.type-components';

export interface LimitedDuration {
	/**
	 * Thời gian kéo dài\
	 * Đơn vị: s
	 */
	duration?: number;
}

interface ImpactVisual extends Renderable {
	/**
	 * @override
	 * Hiệu ứng hiển thị khi impact (va chạm)
	 */
	visual?: VisualManifest;
}

export interface Impactable {
	impact: {
		/**
		 * Danh sách các xử lý khi trúng đích, mở rộng hết cỡ để cấu hình xử lý khác nhau tùy vào mục trúng đòn
		 */
		actions: ImpactAction[];

		/**
		 * Impact diễn ra nhiều lần theo interval, đơn vị: giây
		 * - Nếu khai báo, skill impact nhiều lần theo interval đó
		 * - Nếu không khai báo thì chỉ impact 1 lần
		 */
		interval?: number;
	} & ImpactVisual; // Hiệu ứng khi va chạm
}
```


dsl/combat/visual.enums.ts:
```typescript
type DefaultNormalAttackSprite = 'normal-attack';
type DefaultPhysicNormalAttackHitSprite = 'physic-hit';
type DefaultEnergyNormalAttackHitSprite = 'energy-hit';

export type SpriteKey =
	| DefaultNormalAttackSprite
	| DefaultPhysicNormalAttackHitSprite
	| DefaultEnergyNormalAttackHitSprite
	| (string & {});
```


dsl/combat/visual.type-components.ts:
```typescript
import { SpriteDeclaration } from './visual.types';

export interface VisualManifest {
	/**Khai báo sprite */
	sprite: SpriteDeclaration;

	/**Góc xoay hình (degrees) mặc định là 0 */
	rotate?: number;

	/**Thời gian tồn tại effect, mặc định: 0 - Tức hiệu ứng sẽ biến mất ngay khi entity biến mất */
	duration?: number | 'sprite-end';
}

export interface Renderable {
	/**Không khai báo = invisible (dùng cho skill ẩn hoặc chỉ logic) */
	visual?: VisualManifest;
}

export interface TextVisual {
	/**
	 * Quyết định hiển thị số bay lên thẳng hay chéo.
	 * Công thức tính góc dự kiến: 90 + `text-delta-angle` * 15
	 * Mặc định: `0` (bay thẳng lên: 90 + 0 * 15)
	 */
	'text-delta-angle'?: -1 | 0 | 1;
}
```


dsl/combat/visual.types.ts:
```typescript
import { SpriteKey } from './visual.enums';

/** Khai báo sprite để hiển thị */
export type SpriteDeclaration = {
	/** Key của sprite trong asset manifest */
	key: SpriteKey;

	/** Ghi đè kích thước gốc của sprite (pixels). Không khai báo = dùng kích thước gốc */
	'display-size'?: { width: number; height: number };
};
```


dsl/entity/skill/.type-components.ts:
```typescript
import { RequireCharge, RequireDelay, SkillCastAction } from './actions/.types';
import { CastingMethod, TargetedCast } from './context/casting-methods.type-components';
import { ValueWithUnit } from '../../.types';
import { ApplyEffect } from './actions/apply-effect.type-entities';

/** Tiêu hao cả năng lượng và máu */
type SkillConsumptionBuilder<T extends string[] = []> = Partial<{ [K in T[number]]: ValueWithUnit }>;
type CONSUMPTION_TYPES = ['limit-HP', 'current-HP', 'energy'];

/**
 * Khai báo tiêu hao khi dùng skill
 * *Lý do khai báo riêng mà không cho vào action là do vấn đề gồng. Phải là trừ trước khi gồng, không phải gồng xong mới trừ*
 */
export type SkillConsumption = SkillConsumptionBuilder<CONSUMPTION_TYPES>;

/** Thời gian hồi chiêu dùng chung cho mọi skill */
export interface SkillTiming {
	/** Thời gian hồi chiêu, đơn vị: giây (Mặc định: 0) */
	cooldown?: number;
}

/**
 * Khai báo tiêu hao và các thuộc tính của skill
 */
export interface ActionProps {
	/** Object do skill tạo ra mang tính chất là đánh thường hay skill */
	property?: 'skill' | 'normal-attack';

	/** Skill tiêu hao gì, nếu không đủ, không dùng được, mặc định không tiêu hao */
	'resource-consumption'?: SkillConsumption;

	/** Khai báo cần khựng/gồng, mặc định không cần */
	'activation-require'?: RequireCharge | RequireDelay;
}

export type ActionBased = {
	/**
	 * Khai báo indicator hiển thị cho người chơi, không ảnh hưởng logic.
	 * Mặc định: không hiển thị indicator
	 */
	'casting-method'?: CastingMethod;
	actions: SkillCastAction[];
} & ActionProps;
```


dsl/entity/skill/.type-entities.ts:
```typescript
import { SkillEntry } from './active.type-entities';
import { PassiveSkillEntry } from './passive.type-entities';

/**
 * Định nghĩa tổng cho manifest, có thể có phase hoặc skill
 * @todo Cần bổ sung thêm `passive` skill
 */
export interface SkillManifest<Phases extends number[] = []> {
	// Passive skills
	passive: PassiveSkillEntry<Phases>[];

	// Active skills
	'normal-attack': SkillEntry<Phases>;
	s1: SkillEntry<Phases>;
	s2: SkillEntry<Phases>;
	ultimate: SkillEntry<Phases>;
}
```


dsl/entity/skill/.types.ts:
```typescript
export type SkillTypeDef<Type extends string, Definition extends Record<string, any> = {}> = {
	type: Type;
} & Definition;
```


dsl/entity/skill/actions/.enums.ts:
```typescript
import { RandomDefinition } from '../../../.enums';

/**
 * Các action prefix:
 *
 * - `create`: Tạo ra gì đó, ví dụ: đạn, area damage (chém bán nguyệt, vùng ST,...),...
 * - `do`: Các hành vi cơ học như lướt, nhảy,...
 * - `apply`: Gây ST, hồi máu, gây hiệu ứng,... Nói chung là các effect gây ra khi skill trúng đích
 */
export type ActionPrefix = 'create-entity' | 'do-act' | 'apply';

/**
 * Khai báo action skill cần loại thông tin tổng quát gì:
 *
 * - `none`: Không cần thông tin gì
 * - `direction`: Cần biết hướng chuột (ví dụ: bắn đạn, lướt,...)
 * - `position`: Cần biết vị trí chuột (ví dụ: cast area, dịch chuyển,...)
 * - `target`: Cần khóa mục tiêu cụ thể (ví dụ: skill khóa mục tiêu)
 */
// export type ActionTargetingRequire = 'none' | 'direction' | 'position' | 'target';

export type LockMethod = 'active-lock' | 'nearest' | 'weakest' | RandomDefinition;
```


dsl/entity/skill/actions/.type-components.ts:
```typescript
import { RandomDefinition } from '../../../.enums';
import { ActionPrefix, LockMethod } from './.enums';

/**
 * Khai báo action mà system cần thực hiện, chẳng hạn như:
 * - Gắn component vào mục tiêu nào đó (tạo effect/gây damage/...)
 * - Tạo ra entity mới (tạo đạn/area-damage/...)
 * - Hay hành vi đặc thù gì đó (lướt/nhảy/... dự phòng vì chưa biết tạo entity mới hay gắn component)
 */
export interface ActionType<Action extends ActionPrefix, Type extends string = ''> {
	/** Format: `@{action}` */
	action: `@${Action}${Type extends '' ? '' : `:${Type}`}`;
}

interface UseStrategy<T extends string> {
	strategy?: { type: T } & Record<string, any>;
}

/**
 * Loại skill không ngữ cảnh cần modify direction dùng strategy này
 */
export interface UseDirectionStrategy extends UseStrategy<'direction'> {
	/**
	 * Mặc định là `{ type: 'direction' }`
	 */
	strategy?: {
		type: 'direction';

		/**
		 * Góc (đơn vị: deg) được cộng vào hướng đã chọn
		 * @default 0
		 */
		'delta-angle'?: number | RandomDefinition;
	};
}

/**
 * Loại skill cần ngữ cảnh dùng strategy này
 */
export interface UseTargetingStrategy extends UseStrategy<'targeting'> {
	strategy: {
		type: 'targeting';

		/**
		 * - `active-lock`: Lấy (các) mục tiêu trong phạm vi bán kính 25px quanh trỏ chuột
		 * - `nearest`: Lấy (các) mục tiêu gần nhất
		 * - `random`: Lấy (các) mục tiêu ngẫu nhiên
		 * - `weakest`: Lấy (các) mục tiêu thấp máu nhất
		 *
		 * @default 'active-lock'
		 */
		method?: LockMethod;

		/**
		 * Quy định số mục tiêu tối đa bị khóa
		 * @default 1
		 */
		'limit-target'?: boolean;
	};
}
```


dsl/entity/skill/actions/.types.ts:
```typescript
import { Faction } from '../../../combat/.enums';
import { LimitedDuration } from '../../../combat/state.type-components';
import { Renderable, VisualManifest } from '../../../combat/visual.type-components';
import { ApplyEffect, ChangePhase } from './apply-effect.type-entities';
import { CreateNonContextImpactor, CreateContextImpactor } from './create-attack.type-entities';

export type SkillCastAction = CreateContextImpactor | CreateNonContextImpactor | ChangePhase;
export type PassiveSkillAction = `implement-later:${string}`;

interface RequireDelayBase<Type extends string> extends Renderable {
	type: Type;

	/** Hành động có thể bị phá bởi khống chế hay không, không khai báo thì không thể phá, khai báo thì có */
	breakable?: true;

	/**
	 * @override
	 * Hiệu ứng/aura khi gồng/delay (nếu có)
	 */
	visual?: VisualManifest;
}

/**
 * Cấu hình khựng skill
 */
export interface RequireDelay extends RequireDelayBase<'delay'>, LimitedDuration {
	/**
	 * Thời gian khựng trước khi action thực sự kích hoạt
	 * @override
	 */
	duration: number;

	/**
	 * Có chặn các hành động khác như đang bị khống chế hay không?\
	 * Nếu không khai báo thì là không, nếu khai báo thì bắt buộc là true
	 */
	'block-actions'?: true;
}

/**
 * Cấu hình gồng skill *Làm cơ chế nhấn giữ chiêu + thả
 */
export interface RequireCharge extends RequireDelayBase<'charge'> {
	/**
	 * Thời gian gồng tối đa
	 * @override
	 */
	duration: number;

	/** Thời gian cưỡng chế giữ gồng tối thiểu */
	'min-duration': number;
}

export type ImpactAction<
	TargetEffect extends object = ApplyEffect,
	SelfAction extends object = SkillCastAction | ApplyEffect,
> = {
	/** Mặc định: `['enemy', 'neutral']` */
	'affected-faction'?: Faction[];
} & (
	| {
			'target-effect': TargetEffect[];
			'self-action'?: SelfAction[];
	  }
	| {
			'target-effect'?: TargetEffect[];
			'self-action': SelfAction[];
	  }
);
```


dsl/entity/skill/actions/apply-effect.type-entities.ts:
```typescript
import { ActionType } from './.type-components';
import { StatValue } from '../../../combat/effect.type-components';
import { LimitedDuration } from '../../../combat/state.type-components';
import { TextVisual } from '../../../combat/visual.type-components';
import { DamageType } from '../../tank/.enums';
import { EffectManifest } from './apply-effect.types';

// Sửa HP và MP
type ModifyPoints<ActionTypeName extends string> = ActionType<'apply', ActionTypeName> & StatValue & TextVisual;
export interface DealtDamage extends ModifyPoints<'dealt-damage'> {
	/** Mặc định kế thừa từ tank */
	'damage-type'?: DamageType;

	/**
	 * Cờ để chỉ định main damage để trừ damage trong một số trường hợp, ví dụ khi đạn nảy hay xuyên
	 * @default false
	 */
	'not-main-damage'?: true;
}
export interface RecoverHP extends ModifyPoints<'recover-hp'> {}
export interface ModifyEnergy extends ModifyPoints<'modify-energy'> {}

// Sửa phase
export interface ChangePhase extends ActionType<'do-act', 'change-phase'>, LimitedDuration {
	method: 'next' | `to-phase:${number}`;

	/**
	 * @override
	 * Mặc định: Infinity
	 */
	duration?: number;
}

// Sửa các thứ khác
export interface ModifyCountdown {}
export interface ApplyShield {}

// Khống chế cứng
// TODO: Implement later

export interface ApplyEffect extends ActionType<'apply', 'effect'> {
	'effect-manifest': EffectManifest;
}
```


dsl/entity/skill/actions/apply-effect.types.ts:
```typescript
import { StatValue } from '../../../combat/effect.type-components';
import { LimitedDuration } from '../../../combat/state.type-components';
import { Renderable, VisualManifest } from '../../../combat/visual.type-components';
import { SkillCastAction } from './.types';
import { DealtDamage, ModifyEnergy, RecoverHP } from './apply-effect.type-entities';

export type EffectAction = DealtDamage | RecoverHP | ModifyEnergy | SkillCastAction;
export interface EffectManifest extends Renderable, LimitedDuration {
	/** Name để nhận diện effect dùng cho stack và hiển thị */
	name?: string;

	/** Mô tả hiển thị */
	description?: string;

	/**
	 * @override
	 * Icon hiển thị
	 */
	visual?: VisualManifest;

	/**
	 * @override
	 * Thời gian tồn tại.\
	 * Cơ chế: Bồi thêm stack -> Reset thời gian về ban đầu\
	 * Mặc định: 0s (VD gây damage bình thường, không có thêm gì)
	 */
	duration?: number;

	/**
	 * Impact diễn ra nhiều lần theo interval, đơn vị: giây
	 * - Nếu khai báo, skill impact nhiều lần theo interval đó
	 * - Nếu không khai báo thì chỉ impact 1 lần
	 */
	interval?: number;

	/**
	 * Định nghĩa hành vi cho từng stack. Quy định luôn số stack tối đa\
	 * Note: Vì effect đã có ngữ cảnh từ impactor nên chỉ cần khai báo effect lên target và action của bản thân trong này
	 *
	 * - Ví dụ [stack1, stack2, stack...]
	 * - action: Khai báo hành động đốt, hoặc áp effect như làm chậm
	 * - interval: tần suất kích hoạt action
	 * - on-start: khi đạt đến stack này sẽ kích hoạt action gì đó
	 * - on-end: khi effect này kết thúc sẽ kích hoạt action gì đó
	 * - visual: hiệu ứng effect, ví dụ lửa tầng 1 khác tầng 2, 3, 4
	 *
	 */
	impacts: {
		/** Khai báo các trạng thái như tăng/giảm tốc/các chỉ số khác... của effect */
		'modify-stats'?: StatValue[];

		/** Khi effect bắt đầu thì gây ra gì đó */
		'on-start'?: (EffectAction | 'clear')[];

		/** Khi đến interval thì làm gì đó */
		'on-interval'?: EffectAction[];

		/** Khi effect kết thúc thì gây ra gì đó */
		'on-end'?: EffectAction[];

		/**
		 * @override
		 * Hiệu ứng của effect, ví dụ đốt hay độc
		 */
		visual?: VisualManifest;
	}[];
}
```


dsl/entity/skill/actions/create-attack.type-entities.ts:
```typescript
import { ActionType, UseDirectionStrategy, UseTargetingStrategy } from './.type-components';
import { Bounceable, Pursuitable } from '../../../combat/props.type-components';
import { Impactable } from '../../../combat/state.type-components';
import { Renderable } from '../../../combat/visual.type-components';
import { Collidable } from '../../../physic/collider.type-conponents';
import { Movable } from '../../../physic/movement.type-components';
import { RequireInitPositionMethod } from '../../../physic/position.type-components';
import { LimitedDistance } from '../../../physic/range.type-components';

interface CreateImpactor
	extends Impactable, ActionType<'create-entity'>, LimitedDistance, Renderable, Collidable, Movable, Bounceable {
	'is-fly-object'?: true;
}

/**
 * Note: Nếu muốn apply effect lên mình thì cần tạo hitbox mang effect lên mình tại chỗ
 */
export interface CreateNonContextImpactor
	extends CreateImpactor, UseDirectionStrategy, RequireInitPositionMethod<'mouse-pos' | 'self-pos' | 'target-pos'> {}

export interface CreateContextImpactor
	extends CreateImpactor, UseTargetingStrategy, RequireInitPositionMethod, Pursuitable {}
```


dsl/entity/skill/active.type-entities.ts:
```typescript
import type { ActionBased, SkillTiming } from './.type-components';
import { SkillTypeDef } from './.types';

/**
 * Skill cơ bản, dùng xong hồi chiêu, không có gì đặc biệt
 */
export type NormalSkill = SkillTiming & ActionBased & SkillTypeDef<'normal'>;

/**
 * Skill có tích lũy
 */
type StackedSkill = SkillTiming &
	ActionBased &
	SkillTypeDef<
		'stacked',
		{
			/** Số stack tối đa */
			'max-stack': 2 | 3 | 5;

			/** Thời gian hồi 1 stack, đơn vị: giây */
			'stack-time': number;
		}
	>;

/**
 * Skill nhiều giai đoạn
 */
type MultiStageSkill = SkillTiming &
	SkillTypeDef<
		'multi-stage',
		{
			/** Danh sách hành vi của các giai đoạn */
			stages: ActionBased[];

			/** Quy định giới hạn thời gian tồn tại của 1 giai đoạn, đơn vị: giây */
			timeout: number;
		}
	>;

// Các union dùng cho manifest
type SingleSkill = NormalSkill | StackedSkill | MultiStageSkill;

/**
 * Skill thay đổi hành vi theo phase (Trạng thái/Hệ)
 */
type PhasedSkill<Phases extends number[]> = {
	type: 'phased';

	/** Định nghĩa từng phase như 1 skill đơn */
	'phases-definition': Record<Phases[number], SingleSkill>;
};

/** Chuyển kiểu theo có phase hay skill */
export type SkillEntry<Phases extends number[]> = Phases extends [] ? SingleSkill : SingleSkill | PhasedSkill<Phases>;
```


dsl/entity/skill/context/.types.ts:
```typescript
type TankEventActors = {
	[K in [
		// Khi dùng skill thì kích hoạt thêm gì đó
		'on-activate-skill',

		// Trigger các event ví dụ fatal damage, HP < 30%,...
		'on-hit-taken',

		// Chưa lường trước được nhưng có thể sẽ dùng
		'on-hit-dealt',

		// Hit only (Trúng skill/đánh thường kích hoạt gì đó hoặc skill/đánh thường trúng đích kích hoạt gì đó)
		'on-skill-taken',
		'on-skill-dealt',
		'on-normal-attack-taken',
		'on-normal-attack-dealt',

		// Hit and dealt damage (Như trên nhưng phải có chịu damage mới kích hoạt)
		'on-skill-taken-damage',
		'on-skill-dealt-damage',
		'on-normal-attack-taken-damage',
		'on-normal-attack-dealt-damage',

		// Khi tử vong hoặc khi kill
		'on-destroy',
		'on-destroyed',
	][number]]: ('self' | 'source' | 'target')[];
};

export interface TankEventActorsMap extends TankEventActors {
	'on-activate-skill': ['self'];
	'on-hit-taken': ['source', 'self'];
	'on-hit-dealt': ['target', 'self'];
	'on-skill-taken': ['source', 'self'];
	'on-skill-dealt': ['target', 'self'];
	'on-normal-attack-taken': ['source', 'self'];
	'on-normal-attack-dealt': ['target', 'self'];
	'on-skill-taken-damage': ['source', 'self'];
	'on-skill-dealt-damage': ['target', 'self'];
	'on-normal-attack-taken-damage': ['source', 'self'];
	'on-normal-attack-dealt-damage': ['target', 'self'];
	'on-destroy': ['target', 'self'];
	'on-destroyed': ['source', 'self'];
}

// Usage in future:
// type T = { [K in SkillEventActorsMap['on-hit'][number]]: any };
```


dsl/entity/skill/context/casting-methods.type-components.ts:
```typescript
/**
 * @description
 * - Mô tả skill được tung ra bằng cách nào để làm indicator
 * - Không chỉ thế, còn giới hạn bớt context mà các action có thể sử dụng
 */

import { LimitedDistance } from '../../../physic/range.type-components';

/**
 * Skill người chơi khóa mục tiêu (Ví dụ: Q mất máu)
 */
export interface TargetedCast extends LimitedDistance {
	type: 'on-target';
}

/** Skill chọn vùng tung ra (Ví dụ: R Magneto) */
export interface AreaCast extends LimitedDistance {
	type: 'at-area';

	/** Không tác động đến logic game, chỉ hiển thị vòng tròn có d = size chỉ định */
	display?: { size: number };
}

/** Skill theo hướng (Ví dụ: E TV)*/
export interface DirectionCast extends LimitedDistance {
	type: 'in-direction';

	/** Không tác động đến logic game, chỉ hiển thị mũi tên có width = size chỉ định */
	display?: { size: number };
}

export type CastingMethod = TargetedCast | AreaCast | DirectionCast;
```


dsl/entity/skill/passive.type-entities.ts:
```typescript
import { TankEventActorsMap } from './context/.types';
import { AttackPowerStats, ShootingStats, SurvivalStats } from '../tank/.types';
import { ValueWithUnit } from '../../.types';

import { SkillTiming } from './.type-components';
import { SkillTypeDef } from './.types';

// Note sửa ActionBased thành chuyên biệt cho passive skill
// import { PassiveSkillAction } from '../actions/skill-actions';
type PassiveSkillAction = `Implement later:${string}`;

/**
 * Bị động kích hoạt theo event - Ví dụ Kirito
 */
type EventTriggeredPassive = SkillTiming &
	SkillTypeDef<
		'event-triggered',
		{
			/** Event nào sẽ trigger */
			'trigger-event': keyof TankEventActorsMap;

			/**
			 * Điều kiện để trigger (optional)
			 * - Ví dụ trigger khi chịu dame, mà chịu xong HP phải dưới 30% mới kích hoạt
			 */
			condition?: [];

			/** Hành động khi trigger */
			actions: PassiveSkillAction[];
		}
	>;

/**
 * Bị động kích hoạt định kỳ theo thời gian (countdown) - Ví dụ: Hồ lô, Khiên LLQ/Iron/Chop
 */
type PeriodicPassive = SkillTiming &
	SkillTypeDef<
		'periodic',
		{
			/** Hành động khi trigger */
			actions: PassiveSkillAction[];

			/** Điều kiện để có thể trigger (optional) */
			conditions?: [];

			// Còn rắc rối khi cần kiểu "Khiên vỡ mới CD", có khi tách thành loại riêng cho lành
		}
	>;

/**
 * Bị động buff chỉ số (có thể có hoặc không có điều kiện) - Ví dụ: Báo đen, Sát thủ
 */
type PermanentBuffPassive = SkillTypeDef<
	'permanent-buff',
	{
		/** Các stat được buff (Triển khai sau) */
		'stat-modifiers': {
			attribute: keyof ShootingStats | keyof SurvivalStats | keyof AttackPowerStats;
			value: ValueWithUnit;
		}[];

		/**
		 * Điều kiện để buff có hiệu lực (optional)
		 * - Ví dụ HP thấp hơn 40% mới tăng tốc
		 * - Xung quanh không có đồng đội
		 */
		conditions?: [];
	}
>;

// Phased passive skill (cho tank có nhiều phase)
type PhasedPassiveSkill<Phases extends number[]> = SkillTypeDef<
	'phased',
	{
		/** Phase ban đầu được dùng */
		'default-phase': Phases[number];

		/** Định nghĩa passive cho từng phase */
		'phases-definition': Record<Phases[number], SinglePassiveSkill>;
	}
>;

// Union type cho tất cả passive skills
type SinglePassiveSkill = EventTriggeredPassive | PeriodicPassive | PermanentBuffPassive;

// Entry type cho passive skill
export type PassiveSkillEntry<Phases extends number[]> = Phases extends []
	? SinglePassiveSkill
	: SinglePassiveSkill | PhasedPassiveSkill<Phases>;
```


dsl/entity/tank/.enums.ts:
```typescript
import { AdditionalStats, AttackPowerStats, ShootingStats, SurvivalStats } from './.types';

/**Thuộc tính tank - Vật lý hay năng lượng */
export type TankDamageType = 'physical' | 'energy';

/**Loại sát thương tạo ra - Vật lý, năng lượng hoặc chuẩn */
export type DamageType = 'true' | TankDamageType;

export type BonusStatStateEnum = `${'limit' | 'current' | 'lost'}${'-HP' | '-energy-point'}`;

export type FireRateEnum = 60 | 90 | 120;
export type CritDamageEnum = 150 | 200;
export type EnergyAmountEnum = 100 | 150 | 200;

export type TankStatValueKey =
	| keyof (ShootingStats & SurvivalStats & Omit<AttackPowerStats, 'damage-type'> & AdditionalStats)
	| BonusStatStateEnum
	| 'movement-speed';
```


dsl/entity/tank/.type-entities.ts:
```typescript
import { MovementSpeedEnum } from '../../physic/movement.enums';
import { AdditionalStats, AttackPowerStats, ShootingStats, SurvivalStats } from './.types';

interface FullStats {
	shooting: ShootingStats;
	survival: SurvivalStats;
	'attack-power': AttackPowerStats;
	additional?: AdditionalStats;
	'movement-speed': MovementSpeedEnum;
}

interface TankManifest {
	/** Thực tế hiện tại không cần, đưa vào đọc manifest cho dễ */
	name: string;

	/** Default: 52.5 */
	'hitbox-size'?: number;

	/** Default: 52.5 */
	'render-size'?: number;

	'stat-components': FullStats;
}

type SkillSlot = 's1' | 's2' | 'ultimate' | 'normal-attack' | 'sp';

export type { TankManifest, ShootingStats, SurvivalStats, AttackPowerStats, AdditionalStats, SkillSlot };
```


dsl/entity/tank/.types.ts:
```typescript
import { ValueWithUnit } from '../../.types';
import { CritDamageEnum, EnergyAmountEnum, FireRateEnum, TankDamageType } from './.enums';
import { FlightSpeedEnum } from '../../physic/movement.enums';
import { RangeEnum } from '../../physic/range.enums';

export interface ShootingStats {
	'fire-rate': FireRateEnum;
	'fire-range': RangeEnum;
	'flight-speed': FlightSpeedEnum;
}

export interface SurvivalStats {
	'limit-HP': number;
	'physical-armor': number;
	'energy-shield': number;
}

export interface AttackPowerStats {
	'damage-type': TankDamageType;
	'attack-power': number;
	penetration: number;
	'crit-damage': CritDamageEnum;
}

export interface AdditionalStats {
	'energy-point': {
		amount: EnergyAmountEnum;
		recover?: {
			every: number;
			value: ValueWithUnit;
		};
	};
}
```


dsl/physic/collider.enums.ts:
```typescript
export type PierceableTarget = 'architecture' | 'self' | 'enemy' | 'ally' | 'non-tank' | 'projectile';
```


dsl/physic/collider.type-conponents.ts:
```typescript
import { PierceableTarget } from './collider.enums';
import { ColliderDeclaration } from './collider.type';

/**
 * Phát hiện va chạm
 */
export interface Collidable {
	/**
	 * Vùng va chạm để phát hiện đánh trúng
	 * Mặc định lấy size tank circle r=80 (160x160)
	 */
	collider?: {
		shape: ColliderDeclaration;

		/** Khai báo các rule xuyên thấu (nếu cần) */
		pierce?: PierceableTarget[] | 'all';

		/**
		 * - Thời gian đợi đến khi collider thực sự hoạt động
		 * - Đơn vị: s
		 * - Mặc định: 0s
		 * - Ví dụ: Space GCL hiện effect trước rồi mới giật
		 */
		'warm-up'?: number;
	};
}
```


dsl/physic/collider.type.ts:
```typescript
type ShapeName = 'rectangle' | 'circle';

interface Shape<Name extends ShapeName> {
	type: Name;
	size: Record<string, number>;
}

/**Hình chữ nhật */
export interface Rectangle extends Shape<'rectangle'> {
	size: {
		/** Chiều rộng (pixels) */
		width: number;

		/** Chiều cao (pixels) */
		height: number;
	};
}

/**Hình tròn hoặc hình quạt */
export interface Circle extends Shape<'circle'> {
	size: {
		/** Bán kính (pixels) */
		radius: number;

		/** Góc cung để tạo hình quạt (degrees). Không khai báo = hình tròn đầy đủ */
		'arc-angle'?: number;
	};
}

/**
 * Collider - Hình dạng dùng để phát hiện va chạm
 */
export type ColliderDeclaration = Rectangle | Circle;
```


dsl/physic/movement.enums.ts:
```typescript
import { TestKey } from '../.enums';
import { InheritDeclaration } from '../.types';

export type SpeedInheritAttribute = InheritDeclaration<'movement-speed' | 'flight-speed' | TestKey>;
export type MovementSpeedEnum = 160 | 165 | 170 | 175 | 180;
export type FlightSpeedEnum = 15 | 17.5;
```


dsl/physic/movement.type-components.ts:
```typescript
import { StraightMovement, TestMovement } from './movement.types';

export interface Movable {
	/** Không khai báo thì đứng im */
	movement?: StraightMovement | TestMovement;
}
```


dsl/physic/movement.types.ts:
```typescript
import { TestKey } from '../.enums';
import { ValueWithUnit } from '../.types';
import { FlightSpeedEnum, MovementSpeedEnum } from './movement.enums';

type MovementType = 'straight' | TestKey;

interface BaseMovement<T extends MovementType> {
	'move-type': T;

	/**
	 * Mặc định: `{ value: '100%', of: 'flight-speed' }`
	 */
	speed?: {
		/**@default '100%' */
		value: ValueWithUnit<true, FlightSpeedEnum | MovementSpeedEnum | (number & {})>;

		/**@default 'flight-speed' */
		of?: 'movement-speed' | 'flight-speed';
	};
}

// 2. Specific movement configs
export interface StraightMovement extends BaseMovement<'straight'> {}
export interface TestMovement extends BaseMovement<TestKey> {}
```


dsl/physic/position.enums.ts:
```typescript
export type PositionDeclaration = 'self-pos' | 'target-pos' | 'skill-pos' | 'mouse-pos';
```


dsl/physic/position.type-components.ts:
```typescript
import { PositionDeclaration } from './position.enums';

export interface RequireInitPositionMethod<T extends PositionDeclaration = PositionDeclaration> {
	/**
	 * Skill xuất phát từ đâu
	 * @default "self-pos"
	 */
	from?: T;
}
```


dsl/physic/range.enums.ts:
```typescript
export type RangeEnum = 1000 | 710 | 552 | 480 | 408 | 336 | 260 | 180 | 168;
```


dsl/physic/range.type-components.ts:
```typescript
import { ValueWithUnit } from '../.types';
import { RangeEnum } from './range.enums';

/** Tính chất có giới hạn phạm vi */
export interface LimitedDistance {
	/**
	 * - Với đơn vị là %, nó sẽ lấy `tầm bắn tank` * `% khai báo` / 100
	 * - Mặc định không khai báo sẽ kế thừa tầm đánh của tank, tức: `'100%'`
	 * - **Note**: Cẩn thận xử lý giá trị 0 và giá trị âm
	 */
	'limit-range'?: ValueWithUnit<true, RangeEnum | (number & {})>;
}

// Phạm vi 1000
const e1: LimitedDistance = { 'limit-range': '1000u +*1.5/s' };
```


tsconfig.json:
```json
{
	"compilerOptions": {
		"target": "ES2020",
		"module": "esnext",
		"moduleResolution": "node10",
		"esModuleInterop": true,
		"allowSyntheticDefaultImports": true,
		"strict": true,
		"skipLibCheck": true,
		"forceConsistentCasingInFileNames": true,
		"resolveJsonModule": true,
		"isolatedModules": true,
		"noEmit": true,
		"allowJs": true,
		"checkJs": false,
		"baseUrl": "."
	},
	"include": ["**/*.ts", "**/*.js", "**/.*.ts", "**/.*.js", "dsl/.examples/base.ts"],
	"exclude": ["node_modules"]
}
```

