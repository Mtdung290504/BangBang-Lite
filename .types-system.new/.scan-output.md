# Code Scan Results

Thời gian quét: 17:43:21 8/12/2025
Tổng số file: 22
Tool scanner: index.js (đã bỏ qua)

---

dsl/combat/action.enums.ts:

```typescript
import { RandomDefinition } from '../.enums';
import { TypedRecord } from '../.types';

/**
 * Các action prefix:
 *
 * - `create`: Tạo ra gì đó, ví dụ: đạn, area damage (chém bán nguyệt, vùng ST,...),...
 * - `do`: Các hành vi cơ học như lướt, nhảy,...
 * - `apply`: Gây ST, hồi máu, gây hiệu ứng,... Nói chung là các effect gây ra khi skill trúng đích
 */
export type ActionPrefix = 'create-entity' | 'do-action' | 'apply-effect';

/**
 * Khai báo action skill cần loại thông tin tổng quát gì:
 *
 * - `none`: Không cần thông tin gì
 * - `direction`: Cần biết hướng chuột (ví dụ: bắn đạn, lướt,...)
 * - `position`: Cần biết vị trí chuột (ví dụ: cast area, dịch chuyển,...)
 * - `target`: Cần khóa mục tiêu cụ thể (ví dụ: skill khóa mục tiêu)
 */
export type ActionTargetingRequire = 'none' | 'direction' | 'position' | 'target';

/**
 * Map ActionTargetingRequire đến cấu hình chiến thuật phù hợp
 */
export type TargetingStrategyMap = TypedRecord<
	ActionTargetingRequire,
	any,
	{
		/** Nếu không có, mặc định là 0 */
		direction: {
			/** Góc delta (đơn vị: deg) được cộng vào hướng đã chọn */
			'delta-angle': number | RandomDefinition;
		} | null;

		/** Nếu không chỉ định chiến thuật này, mặc định đơn mục tiêu, chọn bằng trỏ chuột */
		target: {
			/**
			 * - `lock`: Lấy (các) mục tiêu trong phạm vi bán kính 25px quanh trỏ chuột
			 * - `nearest`: Lấy (các) mục tiêu gần nhất
			 * - `random`: Lấy (các) mục tiêu ngẫu nhiên
			 * - `weakest`: Lấy (các) mục tiêu thấp máu nhất
			 *
			 * **Mặc định**: `lock`
			 */
			method?: 'lock' | 'nearest' | 'weakest' | RandomDefinition;

			/** Quy định số mục tiêu tối đa bị khóa, mặc định: 1 */
			'limit-target'?: boolean;
		} | null;

		none: null;
		position: null;
	}
>;
```

dsl/combat/action.type-components.ts:

```typescript
import { ActionPrefix, ActionTargetingRequire, TargetingStrategyMap } from './action.enums';

/**
 * Khai báo action mà system cần thực hiện, chẳng hạn như:
 * - Gắn component vào mục tiêu nào đó (tạo effect/gây damage/...)
 * - Tạo ra entity mới (tạo đạn/area-damage/...)
 * - Hay hành vi đặc thù gì đó (lướt/nhảy/... dự phòng vì chưa biết tạo entity mới hay gắn component)
 */
export interface ActionType<Action extends ActionPrefix, Type extends string = ''> {
	/** Format: `@{action}` */
	action: `@${Action}${Type extends '' ? '' : `:${Type}`}`;
}

/**
 * Cấu hình cách chọn mục tiêu của kỹ năng
 * @template T - Chế độ nhắm mục tiêu
 */
export interface TargetingConfig<T extends ActionTargetingRequire> {
	targeting: {
		/**
		 * Chế độ chọn mục tiêu:
		 * - `none`: Skill có thể dùng từ bản thân mà không yêu cầu gì cả
		 * - `direction`: Cần chọn hướng chuột
		 * - `position`: Cần chọn vị trí trên bản đồ
		 * - `target`: Cần chọn mục tiêu cụ thể
		 */
		require: T;

		/** Cấu hình bổ sung, tùy vào mode, truy cập sâu vào type để xem chi tiết */
		strategy: TargetingStrategyMap[T];
	};
}
```

dsl/combat/action.types.ts:

```typescript

```

dsl/combat/effect.type-components.ts:

```typescript
import { ValueWithUnit } from '../.types';
import { TankStatValueKey } from '../entity/tank/.enums';

export interface StatValue<T extends TankStatValueKey = TankStatValueKey> {
	'value-from': {
		attribute: T;

		/** Mặc định: `target` */
		of?: 'self' | 'target';
	};

	value: ValueWithUnit;
}
```

dsl/combat/state.type-components.ts:

```typescript
import { Faction } from './.enums';

export interface LimitedDuration {
	/** Thời gian kéo dài, mặc định: `Infinity` */
	duration?: number;
}

export interface Impactable<TargetHandler extends object, SelfHandler extends object> {
	/** Skill entity có biến mất khi trúng mục tiêu hay không (mặc định: `true`) */
	'break-on-impact'?: boolean;

	'on-impact': ({
		/** Mặc định: `enemy` */
		'affected-faction'?: Faction;
	} & (
		| {
				'target-effect': TargetHandler;
				'self-action'?: SelfHandler;
		  }
		| {
				'target-effect'?: TargetHandler;
				'self-action': SelfHandler;
		  }
	))[];
}

export interface IgnoreArchitecture {
	/** Mặc định: false */
	'ignore-architecture'?: boolean;
}
```

dsl/combat/visual.enums.ts:

```typescript
export type DefaultNormalAttackSprite = 'normal-attack';
export type SpriteKey = DefaultNormalAttackSprite | (string & {});
```

dsl/combat/visual.type-components.ts:

```typescript
import { SpriteDeclaration } from './visual.types';

/** Component visual - Render sprite */
export interface Renderable {
	/**Không khai báo = invisible (dùng cho skill ẩn hoặc chỉ logic) */
	visual?: {
		/**Khai báo sprite */
		sprite: SpriteDeclaration;

		/**Góc xoay hình (degrees) mặc định là 0 */
		rotate?: number;
	};
}

export interface TextVisual {
	/**
	 * Quyết định hiển thị số bay lên thẳng hay chéo.
	 * Mặc định: `main` (bay thẳng lên)
	 */
	'display-type'?: 'mid' | 'left' | 'right';
}
```

dsl/combat/visual.types.ts:

```typescript
import { SpriteKey } from './visual.enums';

/** Khai báo sprite để hiển thị */
export type SpriteDeclaration = {
	/** Key của sprite trong asset manifest */
	key: SpriteKey;

	/** Ghi đè kích thước gốc của sprite (pixels). Không khai báo = dùng kích thước gốc */
	'display-size'?: { width: number; height: number };
};
```

dsl/entity/skill/actions/apply-effect.type-entities.ts:

```typescript
import { ActionType } from '../../../combat/action.type-components';
import { StatValue } from '../../../combat/effect.type-components';
import { LimitedDuration } from '../../../combat/state.type-components';
import { TextVisual } from '../../../combat/visual.type-components';
import { DamageType } from '../../tank/.enums';

export interface DealtDamage extends ActionType<'apply-effect', 'dealt-damage'>, StatValue, TextVisual {
	/** Mặc định kế thừa từ tank */
	'damage-type'?: DamageType;

	/** Cờ để trừ damage trong một số trường hợp, ví dụ khi đạn nảy hay xuyên */
	'is-main-damage'?: boolean;
}
export interface RecoverHP extends ActionType<'apply-effect', 'recover-hp'>, StatValue, TextVisual {}

export interface ModifyStat extends ActionType<'apply-effect', 'modify-stat'>, StatValue, LimitedDuration {}
```

dsl/entity/skill/actions/create-attack.type-entities.ts:

```typescript
import { ActionType, TargetingConfig } from '../../../combat/action.type-components';
import { IgnoreArchitecture, Impactable } from '../../../combat/state.type-components';
import { Renderable } from '../../../combat/visual.type-components';
import { Collidable } from '../../../physic/collider.type-conponents';
import { Movable } from '../../../physic/movement.type-components';
import { RequireInitPositionMethod } from '../../../physic/position.type-components';
import { LimitedDistance } from '../../../physic/range.type-components';

import { SkillCastAction, SkillHitAction } from './.type-pack';

export interface CreateImpactor
	extends ActionType<'create-entity'>,
		TargetingConfig<'direction'>,
		RequireInitPositionMethod,
		LimitedDistance,
		Renderable,
		Impactable<SkillHitAction, SkillCastAction>,
		IgnoreArchitecture,
		Collidable,
		Movable {}

// Example
const skill_1: CreateImpactor = {
	action: '@create-entity',
	targeting: { require: 'direction', strategy: null },

	// Tầm, hướng bay, xuất phát từ đâu
	'limit-range': 'inherit:fire-range',
	movement: { 'move-type': 'straight', speed: 17.5 },
	from: 'self-pos',

	collider: { shape: 'circle', size: { radius: 20 } },
	'break-on-impact': true,

	visual: { sprite: { key: 'normal-attack' } },
	'on-impact': [
		{
			'target-effect': {
				action: '@apply-effect:modify-stat',
				value: { amount: 10 },
				'value-from': { attribute: 'lost-energy-point', of: 'self' },
			},
		},
	],
};
```

dsl/entity/skill/actions/do-action.type-entities.ts:

```typescript
import { ActionType } from '../../../combat/action.type-components';
import { IgnoreArchitecture, Impactable, LimitedDuration } from '../../../combat/state.type-components';
import { Movable } from '../../../physic/movement.type-components';
import { LimitedDistance } from '../../../physic/range.type-components';

import { SkillCastAction, SkillHitAction } from './.type-pack';

export interface ChangePhase extends ActionType<'do-action', 'change-phase'>, LimitedDuration {
	method: 'next' | `to-phase:${number}`;
}

export interface Dash
	extends ActionType<'do-action', 'dash'>,
		LimitedDistance,
		Movable,
		Impactable<SkillHitAction, SkillCastAction>,
		IgnoreArchitecture {}
```

dsl/physic/collider.type-conponents.ts:

```typescript
import { ColliderDeclaration } from './collider.type';

/**
 * Phát hiện va chạm
 */
export interface Collidable {
	/** Vùng va chạm để phát hiện đánh trúng */
	collider: ColliderDeclaration;
}
```

dsl/physic/collider.type.ts:

```typescript
type ShapeName = 'rectangle' | 'circle';

interface Shape<Name extends ShapeName> {
	shape: Name;
	size: Record<string, number>;
}

/**Hình chữ nhật */
export interface Rectangle extends Shape<'rectangle'> {
	size: {
		/** Chiều rộng (pixels) */
		width: number;

		/** Chiều cao (pixels) */
		height: number;
	};
}

/**Hình tròn hoặc hình quạt */
export interface Circle extends Shape<'circle'> {
	size: {
		/** Bán kính (pixels) */
		radius: number;

		/** Góc cung để tạo hình quạt (degrees). Không khai báo = hình tròn đầy đủ */
		'arc-angle'?: number;
	};
}

/**
 * Collider - Hình dạng dùng để phát hiện va chạm
 */
export type ColliderDeclaration = Rectangle | Circle;
```

dsl/physic/movement.enums.ts:

```typescript
import { TestKey } from '../.enums';
import { InheritDeclaration } from '../.types';

export type SpeedInheritAttribute = InheritDeclaration<'movement-speed' | 'flight-speed' | TestKey>;
export type MovementSpeedEnum = 160 | 165 | 170 | 175 | 180;
export type FlightSpeedEnum = 15 | 17.5;
```

dsl/physic/movement.type-components.ts:

```typescript
import { StraightMovement, TestMovement } from './movement.types';

export interface Movable {
	movement: StraightMovement | TestMovement;
}
```

dsl/physic/movement.types.ts:

```typescript
import { TestKey } from '../.enums';
import { FlightSpeedEnum, MovementSpeedEnum } from './movement.enums';

type MovementType = 'straight' | TestKey;

interface BaseMovement<T extends MovementType> {
	'move-type': T;
}

// 2. Specific movement configs
export interface StraightMovement extends BaseMovement<'straight'> {
	speed: FlightSpeedEnum | MovementSpeedEnum;
}

export interface TestMovement extends BaseMovement<TestKey> {
	speed: FlightSpeedEnum | MovementSpeedEnum;
}
```

dsl/physic/position.enums.ts:

```typescript
export type PositionDeclaration = 'self-pos' | 'target-pos' | 'skill-pos' | 'mouse-pos';
```

dsl/physic/position.type-components.ts:

```typescript
import { PositionDeclaration } from './position.enums';

export interface RequireInitPositionMethod<T extends PositionDeclaration = PositionDeclaration> {
	from: T;
}
```

dsl/physic/range.enums.ts:

```typescript
import { TestKey } from '../.enums';
import { InheritDeclaration } from '../.types';

export type RangeInheritAttribute = InheritDeclaration<'fire-range' | TestKey>;
export type RangeEnum = 1000 | 710 | 552 | 480 | 408 | 336 | 260 | 180 | 168;
```

dsl/physic/range.type-components.ts:

```typescript
import { RangeInheritAttribute } from './range.enums';

/** Tính chất có giới hạn phạm vi */
export interface LimitedDistance {
	'limit-range': number | RangeInheritAttribute;
}
```

tsconfig.json:

```json
{
	"compilerOptions": {
		"target": "ES2020",
		"module": "esnext",
		"moduleResolution": "node10",
		"esModuleInterop": true,
		"allowSyntheticDefaultImports": true,
		"strict": true,
		"skipLibCheck": true,
		"forceConsistentCasingInFileNames": true,
		"resolveJsonModule": true,
		"isolatedModules": true,
		"noEmit": true,
		"allowJs": true,
		"checkJs": false,
		"baseUrl": "."
	},
	"include": ["**/*.ts", "**/*.js", "**/.*.ts", "**/.*.js"],
	"exclude": ["node_modules"]
}
```
